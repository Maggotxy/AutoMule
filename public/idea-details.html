<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æƒ³æ³•è¯¦æƒ… - iFlow</title>

    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Fraunces:wght@400;600;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;600;700&display=stylesheet" rel="stylesheet">

    <!-- Icons -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">

    <!-- Custom Styles -->
    <link rel="stylesheet" href="/css/organic.css">

    <style>
        * {
            box-sizing: border-box;
        }

        body {
            margin: 0;
            padding: 0;
            font-family: 'Nunito', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 16px;
            padding: 20px 24px;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
        }

        .header h1 {
            margin: 0;
            font-family: 'Fraunces', serif;
            font-size: 24px;
            color: #2c3e50;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .header-actions {
            display: flex;
            gap: 12px;
        }

        .btn {
            padding: 8px 16px;
            border-radius: 10px;
            border: 1px solid rgba(0, 0, 0, 0.1);
            background: rgba(0, 0, 0, 0.05);
            color: inherit;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            display: inline-flex;
            align-items: center;
            gap: 6px;
        }

        .btn:hover {
            background: rgba(0, 0, 0, 0.1);
            transform: translateY(-1px);
        }

        .btn-primary {
            background: rgba(52, 152, 219, 0.15);
            border-color: rgba(52, 152, 219, 0.3);
            color: #3498db;
        }

        .btn-primary:hover {
            background: rgba(52, 152, 219, 0.25);
        }

        .stats-bar {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 16px;
            padding: 16px 24px;
            margin-bottom: 20px;
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 16px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
        }

        .stat-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px;
            background: rgba(0, 0, 0, 0.03);
            border-radius: 12px;
            border: 1px solid rgba(0, 0, 0, 0.06);
        }

        .stat-icon {
            font-size: 24px;
            width: 48px;
            height: 48px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 12px;
            background: rgba(255, 255, 255, 0.8);
        }

        .stat-icon.web {
            background: rgba(52, 152, 219, 0.15);
            color: #3498db;
        }

        .stat-icon.ai {
            background: rgba(155, 89, 182, 0.15);
            color: #9b59b6;
        }

        .stat-icon.cached {
            background: rgba(46, 204, 113, 0.15);
            color: #2ecc71;
        }

        .stat-icon.total {
            background: rgba(241, 196, 15, 0.15);
            color: #f39c12;
        }

        .stat-info {
            flex: 1;
        }

        .stat-label {
            font-size: 12px;
            color: rgba(0, 0, 0, 0.6);
            margin-bottom: 4px;
        }

        .stat-value {
            font-size: 24px;
            font-weight: 700;
            color: #2c3e50;
        }

        .ideas-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(400px, 1fr));
            gap: 20px;
        }

        .idea-card {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 16px;
            padding: 20px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
            cursor: pointer;
            transition: all 0.3s ease;
            border: 1px solid rgba(0, 0, 0, 0.06);
            position: relative;
            overflow: hidden;
        }

        .idea-card::before {
            content: '';
            position: absolute;
            left: 0;
            top: 0;
            bottom: 0;
            width: 4px;
            background: var(--source-color, #3498db);
        }

        .idea-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 8px 30px rgba(0, 0, 0, 0.15);
        }

        .idea-card.source-web {
            --source-color: #3498db;
        }

        .idea-card.source-ai {
            --source-color: #9b59b6;
        }

        .idea-card.source-cached {
            --source-color: #2ecc71;
        }

        .idea-header {
            display: flex;
            align-items: flex-start;
            justify-content: space-between;
            margin-bottom: 12px;
            padding-left: 8px;
        }

        .idea-source {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 13px;
            font-weight: 600;
            color: rgba(0, 0, 0, 0.7);
        }

        .idea-source-icon {
            font-size: 18px;
        }

        .idea-time {
            font-size: 11px;
            color: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .idea-content {
            font-size: 14px;
            color: rgba(0, 0, 0, 0.85);
            line-height: 1.6;
            margin-bottom: 16px;
            padding-left: 8px;
        }

        .idea-analysis {
            background: rgba(52, 152, 219, 0.08);
            border-radius: 10px;
            padding: 12px;
            margin-bottom: 16px;
            border: 1px solid rgba(52, 152, 219, 0.15);
        }

        .analysis-title {
            font-size: 12px;
            font-weight: 600;
            color: rgba(0, 0, 0, 0.6);
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .analysis-content {
            font-size: 13px;
            color: rgba(0, 0, 0, 0.75);
            line-height: 1.5;
        }

        .idea-tags {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-bottom: 16px;
            padding-left: 8px;
        }

        .tag {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            padding: 4px 10px;
            border-radius: 999px;
            font-size: 11px;
            font-weight: 600;
            background: rgba(0, 0, 0, 0.05);
            border: 1px solid rgba(0, 0, 0, 0.08);
        }

        .tag.source {
            background: rgba(52, 152, 219, 0.1);
            border-color: rgba(52, 152, 219, 0.2);
            color: #3498db;
        }

        .tag.analysis {
            background: rgba(155, 89, 182, 0.1);
            border-color: rgba(155, 89, 182, 0.2);
            color: #9b59b6;
        }

        .tag.problem {
            background: rgba(231, 76, 60, 0.1);
            border-color: rgba(231, 76, 60, 0.2);
            color: #e74c3c;
        }

        .idea-actions {
            display: flex;
            gap: 8px;
            padding-left: 8px;
        }

        .idea-actions .btn {
            flex: 1;
            justify-content: center;
            font-size: 12px;
            padding: 8px 12px;
        }

        .empty-state {
            grid-column: 1 / -1;
            text-align: center;
            padding: 80px 20px;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 16px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
        }

        .empty-state i {
            font-size: 64px;
            color: rgba(0, 0, 0, 0.2);
            margin-bottom: 20px;
        }

        .empty-state h2 {
            margin: 0 0 12px 0;
            font-family: 'Fraunces', serif;
            font-size: 24px;
            color: #2c3e50;
        }

        .empty-state p {
            margin: 0;
            font-size: 14px;
            color: rgba(0, 0, 0, 0.6);
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: rgba(0, 0, 0, 0.6);
        }

        .loading i {
            font-size: 32px;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            from {
                transform: rotate(0deg);
            }

            to {
                transform: rotate(360deg);
            }
        }

        /* Modal styles */
        .modal-overlay {
            display: none;
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .modal-overlay.active {
            display: flex;
        }

        .modal {
            background: white;
            border-radius: 16px;
            max-width: 800px;
            width: 100%;
            max-height: 90vh;
            overflow: auto;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        }

        .modal-header {
            padding: 20px 24px;
            border-bottom: 1px solid rgba(0, 0, 0, 0.1);
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .modal-header h2 {
            margin: 0;
            font-family: 'Fraunces', serif;
            font-size: 20px;
            color: #2c3e50;
        }

        .modal-close {
            width: 36px;
            height: 36px;
            border-radius: 10px;
            border: none;
            background: rgba(0, 0, 0, 0.05);
            color: inherit;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
        }

        .modal-close:hover {
            background: rgba(0, 0, 0, 0.1);
        }

        .modal-body {
            padding: 24px;
        }

        .modal-footer {
            padding: 16px 24px;
            border-top: 1px solid rgba(0, 0, 0, 0.1);
            display: flex;
            gap: 12px;
            justify-content: flex-end;
        }
    </style>
</head>

<body>
    <div class="container">
        <!-- Header -->
        <div class="header">
            <h1>
                <i class="bi bi-lightbulb" style="color: #f39c12;"></i>
                æƒ³æ³•è¯¦æƒ…
            </h1>
            <div class="header-actions">
                <button class="btn" onclick="refreshIdeas()">
                    <i class="bi bi-arrow-clockwise"></i> åˆ·æ–°
                </button>
                <button class="btn btn-primary" onclick="manualGenerate()">
                    <i class="bi bi-magic"></i> ç”Ÿæˆæ–°æƒ³æ³•
                </button>
                <button class="btn" onclick="goBack()">
                    <i class="bi bi-arrow-left"></i> è¿”å›
                </button>
            </div>
        </div>

        <!-- Stats Bar -->
        <div class="stats-bar">
            <div class="stat-item">
                <div class="stat-icon web">
                    <i class="bi bi-globe"></i>
                </div>
                <div class="stat-info">
                    <div class="stat-label">ç½‘ç»œæ¥æº</div>
                    <div class="stat-value" id="webCount">0</div>
                </div>
            </div>
            <div class="stat-item">
                <div class="stat-icon ai">
                    <i class="bi bi-robot"></i>
                </div>
                <div class="stat-info">
                    <div class="stat-label">AI ç”Ÿæˆ</div>
                    <div class="stat-value" id="aiCount">0</div>
                </div>
            </div>
            <div class="stat-item">
                <div class="stat-icon cached">
                    <i class="bi bi-database"></i>
                </div>
                <div class="stat-info">
                    <div class="stat-label">ç¼“å­˜æƒ³æ³•</div>
                    <div class="stat-value" id="cachedCount">0</div>
                </div>
            </div>
            <div class="stat-item">
                <div class="stat-icon total">
                    <i class="bi bi-collection"></i>
                </div>
                <div class="stat-info">
                    <div class="stat-label">æ€»è®¡</div>
                    <div class="stat-value" id="totalCount">0</div>
                </div>
            </div>
        </div>

        <!-- ğŸ‚ NiuMa å·¥ä½œç»Ÿè®¡é¢æ¿ -->
        <div id="niuMaStatsPanel" class="stats-bar" style="margin-bottom: 20px;">
            <div class="stat-item">
                <div class="stat-icon" style="background: rgba(231, 76, 60, 0.15); color: #e74c3c;">
                    <i class="bi bi-clock-history"></i>
                </div>
                <div class="stat-info">
                    <div class="stat-label">æ€»å·¥ä½œæ—¶é—´</div>
                    <div class="stat-value" id="totalWorkTime">0h</div>
                </div>
            </div>
            <div class="stat-item">
                <div class="stat-icon" style="background: rgba(46, 204, 113, 0.15); color: #2ecc71;">
                    <i class="bi bi-people"></i>
                </div>
                <div class="stat-info">
                    <div class="stat-label">ç‰›é©¬æ•°é‡</div>
                    <div class="stat-value" id="niuMaCount">0</div>
                </div>
            </div>
            <div class="stat-item">
                <div class="stat-icon" style="background: rgba(241, 196, 15, 0.15); color: #f39c12;">
                    <i class="bi bi-fire"></i>
                </div>
                <div class="stat-info">
                    <div class="stat-label">å¹²æ´»ä¸­</div>
                    <div class="stat-value" id="workingNiuMa">0</div>
                </div>
            </div>
            <div class="stat-item">
                <div class="stat-icon" style="background: rgba(155, 89, 182, 0.15); color: #9b59b6;">
                    <i class="bi bi-lightning"></i>
                </div>
                <div class="stat-info">
                    <div class="stat-label">æ€»è¿­ä»£</div>
                    <div class="stat-value" id="totalIterations">0</div>
                </div>
            </div>
        </div>

        <!-- ç‰›é©¬è¯¦æƒ…è¡¨æ ¼ -->
        <div id="niuMaDetails" class="stats-bar" style="margin-bottom: 20px; display: block; padding: 16px;">
            <h3
                style="margin: 0 0 12px 0; font-size: 14px; color: #2c3e50; display: flex; align-items: center; gap: 8px;">
                <i class="bi bi-bar-chart"></i> ç‰›é©¬å·¥ä½œæ˜ç»†
            </h3>
            <div id="niuMaTable" style="font-size: 13px;">
                <div style="color: rgba(0,0,0,0.5);">åŠ è½½ä¸­...</div>
            </div>
        </div>

        <!-- Ideas Grid -->
        <div id="ideasGrid" class="ideas-grid">
            <div class="loading">
                <i class="bi bi-arrow-repeat"></i>
                <p>åŠ è½½ä¸­...</p>
            </div>
        </div>
    </div>

    <!-- Idea Detail Modal -->
    <div class="modal-overlay" id="ideaModal">
        <div class="modal">
            <div class="modal-header">
                <h2 id="modalTitle">æƒ³æ³•è¯¦æƒ…</h2>
                <button class="modal-close" onclick="closeModal()">
                    <i class="bi bi-x-lg"></i>
                </button>
            </div>
            <div class="modal-body" id="modalBody">
                <!-- Dynamic content -->
            </div>
            <div class="modal-footer">
                <button class="btn" onclick="closeModal()">å…³é—­</button>
                <button class="btn btn-primary" onclick="useIdea()">
                    <i class="bi bi-send"></i> ä½¿ç”¨æ­¤æƒ³æ³•
                </button>
            </div>
        </div>
    </div>

    <script>
        let currentIdeas = [];
        let currentSelectedIdea = null;

        // Load ideas on page load
        document.addEventListener('DOMContentLoaded', () => {
            loadIdeas();
            loadNiuMaStats();
            // Auto refresh every 10 seconds
            setInterval(loadIdeas, 10000);
            setInterval(loadNiuMaStats, 5000);
        });

        // åŠ è½½ç‰›é©¬ç»Ÿè®¡
        async function loadNiuMaStats() {
            try {
                const res = await fetch('/api/niuma/stats');
                const data = await res.json();
                if (data.success) {
                    updateNiuMaStats(data);
                }
            } catch (error) {
                console.warn('åŠ è½½ç‰›é©¬ç»Ÿè®¡å¤±è´¥:', error);
            }
        }

        function updateNiuMaStats(data) {
            // æ›´æ–°æ¦‚è§ˆç»Ÿè®¡
            document.getElementById('totalWorkTime').textContent = formatDuration(data.totalWorkMs || 0);
            document.getElementById('niuMaCount').textContent = data.totalNiuma || 0;
            document.getElementById('workingNiuMa').textContent = data.stationStats?.workingCount || 0;
            document.getElementById('totalIterations').textContent = data.stationStats?.totalIterations || 0;

            // æ›´æ–°ç‰›é©¬æ˜ç»†è¡¨æ ¼
            const tableContainer = document.getElementById('niuMaTable');
            if (!data.stats || data.stats.length === 0) {
                tableContainer.innerHTML = '<div style="color: rgba(0,0,0,0.5);">æš‚æ— ç‰›é©¬åœ¨å·¥ä½œ</div>';
                return;
            }

            tableContainer.innerHTML = data.stats.map(niuma => `
                <div style="display: flex; align-items: center; justify-content: space-between; padding: 8px 12px; background: rgba(0,0,0,0.03); border-radius: 8px; margin-bottom: 6px;">
                    <div style="display: flex; align-items: center; gap: 8px;">
                        <span style="font-size: 16px;">${getStatusEmoji(niuma.status)}</span>
                        <span style="font-weight: 600;">${niuma.appId.substring(0, 16)}...</span>
                    </div>
                    <div style="display: flex; gap: 16px; font-size: 12px; color: rgba(0,0,0,0.6);">
                        <span>ğŸ”„ ${niuma.iterationCount}æ¬¡</span>
                        <span>â±ï¸ ${formatDuration(niuma.totalWorkTimeMs)}</span>
                        <span>ğŸ˜´ ${formatDuration(niuma.timeSinceLastRestMs)}æœªä¼‘æ¯</span>
                    </div>
                </div>
            `).join('');
        }

        function getStatusEmoji(status) {
            switch (status) {
                case 'working': return 'ğŸ”¥';
                case 'resting': return 'ğŸ˜´';
                case 'paused': return 'â¸ï¸';
                default: return 'ğŸ’¤';
            }
        }

        function formatDuration(ms) {
            if (!ms || ms < 1000) return '0åˆ†';
            const hours = Math.floor(ms / 3600000);
            const minutes = Math.floor((ms % 3600000) / 60000);
            if (hours > 0) return `${hours}h${minutes}m`;
            return `${minutes}åˆ†`;
        }

        async function loadIdeas() {
            try {
                const res = await fetch('/api/ideas');
                const data = await res.json();

                if (data.success) {
                    currentIdeas = data.ideas || [];
                    updateStats(data);
                    renderIdeas(currentIdeas);
                }
            } catch (error) {
                console.error('åŠ è½½æƒ³æ³•å¤±è´¥:', error);
                showError('åŠ è½½å¤±è´¥ï¼Œè¯·åˆ·æ–°é¡µé¢é‡è¯•');
            }
        }

        function updateStats(data) {
            document.getElementById('webCount').textContent = data.webCount || 0;
            document.getElementById('aiCount').textContent = data.aiCount || 0;
            document.getElementById('cachedCount').textContent = data.cachedCount || 0;
            document.getElementById('totalCount').textContent = currentIdeas.length;
        }

        function renderIdeas(ideas) {
            const container = document.getElementById('ideasGrid');

            if (!ideas || ideas.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <i class="bi bi-lightbulb"></i>
                        <h2>æš‚æ— æƒ³æ³•</h2>
                        <p>å¯åŠ¨èµ›åšå¤§è„‘å¼€å§‹ç”Ÿæˆæƒ³æ³•ï¼Œæˆ–ç‚¹å‡»"ç”Ÿæˆæ–°æƒ³æ³•"æ‰‹åŠ¨åˆ›å»º</p>
                    </div>
                `;
                return;
            }

            container.innerHTML = ideas.map((idea, index) => createIdeaCard(idea, index)).join('');
        }

        function createIdeaCard(idea, index) {
            const sourceIcon = getSourceIcon(idea.source);
            const sourceText = getSourceText(idea.source);
            const timeAgo = formatTimeAgo(idea.timestamp);
            const sourceClass = `source-${idea.source}`;

            return `
                <div class="idea-card ${sourceClass}" onclick="showIdeaDetail(${index})">
                    <div class="idea-header">
                        <div class="idea-source">
                            <span class="idea-source-icon">${sourceIcon}</span>
                            ${sourceText}
                        </div>
                        <div class="idea-time">
                            <i class="bi bi-clock"></i>
                            ${timeAgo}
                        </div>
                    </div>

                    <div class="idea-content">
                        ${escapeHtml(idea.content)}
                    </div>

                    ${idea.analysis ? `
                        <div class="idea-analysis">
                            <div class="analysis-title">
                                <i class="bi bi-graph-up"></i>
                                åˆ†æ
                            </div>
                            <div class="analysis-content">
                                ${escapeHtml(idea.analysis)}
                            </div>
                        </div>
                    ` : ''}

                    <div class="idea-tags">
                        <span class="tag source">${sourceText}</span>
                        ${idea.analysis ? '<span class="tag analysis">å·²åˆ†æ</span>' : '<span class="tag">å¾…åˆ†æ</span>'}
                    </div>

                    <div class="idea-actions">
                        <button class="btn" onclick="event.stopPropagation(); showIdeaDetail(${index})">
                            <i class="bi bi-eye"></i> æŸ¥çœ‹è¯¦æƒ…
                        </button>
                        <button class="btn btn-primary" onclick="event.stopPropagation(); quickUseIdea(${index})">
                            <i class="bi bi-send"></i> ä½¿ç”¨
                        </button>
                    </div>
                </div>
            `;
        }

        function showIdeaDetail(index) {
            const idea = currentIdeas[index];
            if (!idea) return;

            currentSelectedIdea = idea;

            const sourceIcon = getSourceIcon(idea.source);
            const sourceText = getSourceText(idea.source);
            const timeAgo = formatTimeAgo(idea.timestamp);

            document.getElementById('modalTitle').textContent = 'æƒ³æ³•è¯¦æƒ…';
            document.getElementById('modalBody').innerHTML = `
                <div style="margin-bottom: 20px;">
                    <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 16px;">
                        <span style="font-size: 32px;">${sourceIcon}</span>
                        <div>
                            <div style="font-size: 18px; font-weight: 700; color: #2c3e50;">${sourceText}</div>
                            <div style="font-size: 13px; color: rgba(0,0,0,0.6);">
                                <i class="bi bi-clock"></i> ${timeAgo}
                            </div>
                        </div>
                    </div>

                    <div style="background: rgba(0,0,0,0.03); border-radius: 12px; padding: 16px; margin-bottom: 16px;">
                        <div style="font-size: 12px; font-weight: 600; color: rgba(0,0,0,0.6); margin-bottom: 8px;">
                            <i class="bi bi-lightbulb"></i> æƒ³æ³•å†…å®¹
                        </div>
                        <div style="font-size: 15px; line-height: 1.6; color: rgba(0,0,0,0.85);">
                            ${escapeHtml(idea.content)}
                        </div>
                    </div>

                    ${idea.source === 'web' ? `
                        <div style="background: rgba(52, 152, 219, 0.08); border-radius: 12px; padding: 16px; margin-bottom: 16px; border: 1px solid rgba(52, 152, 219, 0.15);">
                            <div style="font-size: 12px; font-weight: 600; color: rgba(0,0,0,0.6); margin-bottom: 8px;">
                                <i class="bi bi-globe"></i> æ¥æºä»‹ç»
                            </div>
                            <div style="font-size: 14px; line-height: 1.6; color: rgba(0,0,0,0.75);">
                                æ­¤æƒ³æ³•æ¥æºäºç½‘ç»œèµ„æºï¼ŒåŒ…æ‹¬ GitHub Trendingã€Product Huntã€Hacker News ç­‰çƒ­é—¨å¹³å°ã€‚é€šè¿‡åˆ†æå½“å‰æŠ€æœ¯è¶‹åŠ¿å’Œç”¨æˆ·éœ€æ±‚ï¼Œæå–å‡ºå…·æœ‰æ½œåŠ›çš„åº”ç”¨åˆ›æ„ã€‚
                            </div>
                        </div>
                    ` : ''}

                    ${idea.source === 'ai' ? `
                        <div style="background: rgba(155, 89, 182, 0.08); border-radius: 12px; padding: 16px; margin-bottom: 16px; border: 1px solid rgba(155, 89, 182, 0.15);">
                            <div style="font-size: 12px; font-weight: 600; color: rgba(0,0,0,0.6); margin-bottom: 8px;">
                                <i class="bi bi-robot"></i> AI ç”Ÿæˆè¯´æ˜
                            </div>
                            <div style="font-size: 14px; line-height: 1.6; color: rgba(0,0,0,0.75);">
                                æ­¤æƒ³æ³•ç”± AI è‡ªåŠ¨ç”Ÿæˆï¼ŒåŸºäºå½“å‰æŠ€æœ¯è¶‹åŠ¿ã€ç”¨æˆ·éœ€æ±‚å’Œå¹³å°ç±»å‹è¿›è¡Œæ™ºèƒ½ç»„åˆã€‚AI ä¼šè€ƒè™‘å®ç”¨æ€§ã€åˆ›æ–°æ€§å’Œå¯è¡Œæ€§ï¼Œç”Ÿæˆå…·æœ‰æ½œåŠ›çš„åº”ç”¨æƒ³æ³•ã€‚
                            </div>
                        </div>
                    ` : ''}

                    ${idea.analysis ? `
                        <div style="background: rgba(46, 204, 113, 0.08); border-radius: 12px; padding: 16px; margin-bottom: 16px; border: 1px solid rgba(46, 204, 113, 0.15);">
                            <div style="font-size: 12px; font-weight: 600; color: rgba(0,0,0,0.6); margin-bottom: 8px;">
                                <i class="bi bi-graph-up"></i> ç—›ç‚¹åˆ†æ
                            </div>
                            <div style="font-size: 14px; line-height: 1.6; color: rgba(0,0,0,0.75);">
                                ${escapeHtml(idea.analysis)}
                            </div>
                        </div>
                    ` : `
                        <div style="background: rgba(241, 196, 15, 0.08); border-radius: 12px; padding: 16px; margin-bottom: 16px; border: 1px solid rgba(241, 196, 15, 0.15);">
                            <div style="font-size: 12px; font-weight: 600; color: rgba(0,0,0,0.6); margin-bottom: 8px;">
                                <i class="bi bi-exclamation-triangle"></i> å¾…åˆ†æ
                            </div>
                            <div style="font-size: 14px; line-height: 1.6; color: rgba(0,0,0,0.75);">
                                æ­¤æƒ³æ³•å°šæœªè¿›è¡Œè¯¦ç»†åˆ†æã€‚ä½¿ç”¨æ­¤æƒ³æ³•åï¼Œç³»ç»Ÿä¼šè‡ªåŠ¨åˆ†æå…¶è§£å†³çš„ç—›ç‚¹å’Œæ½œåœ¨ä»·å€¼ã€‚
                            </div>
                        </div>
                    `}

                    <div style="background: rgba(231, 76, 60, 0.08); border-radius: 12px; padding: 16px; border: 1px solid rgba(231, 76, 60, 0.15);">
                        <div style="font-size: 12px; font-weight: 600; color: rgba(0,0,0,0.6); margin-bottom: 8px;">
                            <i class="bi bi-lightning"></i> è§£å†³çš„é—®é¢˜
                        </div>
                        <div style="font-size: 14px; line-height: 1.6; color: rgba(0,0,0,0.75);">
                            ${generateProblemAnalysis(idea)}
                        </div>
                    </div>
                </div>
            `;

            document.getElementById('ideaModal').classList.add('active');
        }

        function closeModal() {
            document.getElementById('ideaModal').classList.remove('active');
            currentSelectedIdea = null;
        }

        function useIdea() {
            if (!currentSelectedIdea) return;

            // Store the idea in localStorage for the main page to pick up
            localStorage.setItem('selectedIdea', JSON.stringify(currentSelectedIdea));

            // Close modal and go back
            closeModal();
            goBack();
        }

        function quickUseIdea(index) {
            const idea = currentIdeas[index];
            if (!idea) return;

            localStorage.setItem('selectedIdea', JSON.stringify(idea));
            goBack();
        }

        async function manualGenerate() {
            try {
                const res = await fetch('/api/idea-generator/generate', { method: 'POST' });
                const data = await res.json();

                if (data.success && data.idea) {
                    alert(`å·²ç”Ÿæˆæ–°æƒ³æ³•ï¼š\n${data.idea}`);
                    setTimeout(() => loadIdeas(), 500);
                } else {
                    alert('ç”Ÿæˆå¤±è´¥: ' + (data.error || 'æœªçŸ¥é”™è¯¯'));
                }
            } catch (error) {
                console.error('ç”Ÿæˆå¤±è´¥:', error);
                alert('ç½‘ç»œé”™è¯¯ï¼Œè¯·æ£€æŸ¥æ§åˆ¶å°');
            }
        }

        function refreshIdeas() {
            loadIdeas();
        }

        function goBack() {
            // ä¼˜å…ˆä½¿ç”¨æµè§ˆå™¨å†å²è¿”å›
            if (window.history.length > 1) {
                window.history.back();
            } else {
                window.location.href = '/';
            }
        }

        function showError(message) {
            const container = document.getElementById('ideasGrid');
            container.innerHTML = `
                <div class="empty-state">
                    <i class="bi bi-exclamation-circle"></i>
                    <h2>åŠ è½½å¤±è´¥</h2>
                    <p>${message}</p>
                </div>
            `;
        }

        function getSourceIcon(source) {
            switch (source) {
                case 'web': return 'ğŸŒ';
                case 'ai': return 'ğŸ¤–';
                case 'cached': return 'ğŸ’¾';
                default: return 'ğŸ’¡';
            }
        }

        function getSourceText(source) {
            switch (source) {
                case 'web': return 'ç½‘ç»œæ¥æº';
                case 'ai': return 'AI ç”Ÿæˆ';
                case 'cached': return 'ç¼“å­˜æƒ³æ³•';
                default: return 'å…¶ä»–';
            }
        }

        function formatTimeAgo(timestamp) {
            if (!timestamp) return 'åˆšåˆš';

            const now = new Date();
            const time = new Date(timestamp);
            const diff = Math.floor((now - time) / 1000);

            if (diff < 60) return 'åˆšåˆš';
            if (diff < 3600) return `${Math.floor(diff / 60)} åˆ†é’Ÿå‰`;
            if (diff < 86400) return `${Math.floor(diff / 3600)} å°æ—¶å‰`;
            if (diff < 604800) return `${Math.floor(diff / 86400)} å¤©å‰`;
            return time.toLocaleDateString('zh-CN');
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function generateProblemAnalysis(idea) {
            const content = idea.content.toLowerCase();

            if (content.includes('å·¥å…·') || content.includes('æ•ˆç‡') || content.includes('è‡ªåŠ¨åŒ–')) {
                return 'æ­¤æƒ³æ³•æ—¨åœ¨æå‡å·¥ä½œæ•ˆç‡ï¼Œé€šè¿‡è‡ªåŠ¨åŒ–å·¥å…·å‡å°‘é‡å¤æ€§å·¥ä½œï¼Œè®©ç”¨æˆ·èƒ½å¤Ÿä¸“æ³¨äºæ›´æœ‰ä»·å€¼çš„ä»»åŠ¡ã€‚';
            } else if (content.includes('å¯è§†åŒ–') || content.includes('å›¾è¡¨') || content.includes('å±•ç¤º')) {
                return 'æ­¤æƒ³æ³•è§£å†³äº†æ•°æ®å±•ç¤ºçš„é—®é¢˜ï¼Œé€šè¿‡ç›´è§‚çš„å¯è§†åŒ–æ–¹å¼å¸®åŠ©ç”¨æˆ·æ›´å¥½åœ°ç†è§£å’Œåˆ†ææ•°æ®ã€‚';
            } else if (content.includes('æ¸¸æˆ') || content.includes('å¨±ä¹') || content.includes('è¶£å‘³')) {
                return 'æ­¤æƒ³æ³•æä¾›äº†å¨±ä¹ä»·å€¼ï¼Œé€šè¿‡æœ‰è¶£çš„æ¸¸æˆæˆ–äº’åŠ¨ä½“éªŒä¸ºç”¨æˆ·å¸¦æ¥æ”¾æ¾å’Œä¹è¶£ã€‚';
            } else if (content.includes('å­¦ä¹ ') || content.includes('æ•™è‚²') || content.includes('æ•™ç¨‹')) {
                return 'æ­¤æƒ³æ³•è§£å†³äº†å­¦ä¹ éœ€æ±‚ï¼Œé€šè¿‡äº’åŠ¨å¼å­¦ä¹ å¸®åŠ©ç”¨æˆ·æ›´é«˜æ•ˆåœ°æŒæ¡çŸ¥è¯†å’ŒæŠ€èƒ½ã€‚';
            } else if (content.includes('ç¤¾äº¤') || content.includes('äº¤æµ') || content.includes('åä½œ')) {
                return 'æ­¤æƒ³æ³•è§£å†³äº†æ²Ÿé€šåä½œçš„é—®é¢˜ï¼Œé€šè¿‡ä¾¿æ·çš„ç¤¾äº¤åŠŸèƒ½å¸®åŠ©ç”¨æˆ·æ›´å¥½åœ°ä¸ä»–äººäº¤æµå’Œåˆä½œã€‚';
            } else {
                return 'æ­¤æƒ³æ³•é’ˆå¯¹ç‰¹å®šçš„ç”¨æˆ·éœ€æ±‚ï¼Œæä¾›äº†åˆ›æ–°çš„è§£å†³æ–¹æ¡ˆï¼Œæ—¨åœ¨æ”¹å–„ç”¨æˆ·ä½“éªŒæˆ–è§£å†³å®é™…ç—›ç‚¹ã€‚';
            }
        }

        // Close modal on overlay click
        document.getElementById('ideaModal').addEventListener('click', (e) => {
            if (e.target.id === 'ideaModal') {
                closeModal();
            }
        });

        // Close modal on Escape key
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                closeModal();
            }
        });
    </script>
</body>

</html>